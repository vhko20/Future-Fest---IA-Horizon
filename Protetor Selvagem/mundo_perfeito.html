<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mundo Perfeito - Como você imagina?</title>

  <style>
    :root {
      --bg: #0f4a0f;
      --panel: #f2f7f3;
      --header: #20702a;
      --accent: #2b7a2f;
      --muted: #6b7280;
      --yellow: #e3e900;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
        "Helvetica Neue", Arial;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: radial-gradient(circle at 10% 10%,
          #0f6a1a 0%,
          var(--bg) 35%,
          #063a06 100%);
      min-height: 100vh;
      padding: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .container {
      width: 920px;
      background: var(--panel);
      border-radius: 22px;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.35);
      overflow: hidden;
      border: 1px solid rgba(255, 255, 255, 0.35);
    }

    .header {
      background: var(--header);
      color: white;
      padding: 42px 48px;
      text-align: center;
    }

    .header h1 {
      font-size: 44px;
      margin: 0;
      font-weight: 800;
      letter-spacing: 0.6px;
    }

    .header .subtitle {
      margin-top: 12px;
      color: rgba(255, 255, 255, 0.9);
      font-weight: 500;
    }

    .content {
      padding: 34px 60px 48px;
      color: #1f2937;
    }

    .btn-secondary {
      background: #f3f4f6;
      color: #374151;
      border: 2px solid #e5e7eb;
      padding: 8px 16px;
      font-size: 14px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-secondary:hover {
      background: #e5e7eb;
      transform: translateY(-1px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    h3 {
      text-align: center;
      margin-top: 6px;
      margin-bottom: 24px;
      font-weight: 700;
      color: #2e3b45;
    }

    textarea {
      width: 100%;
      padding: 18px 20px;
      border-radius: 16px;
      background: white;
      border: 1px solid rgba(0, 0, 0, 0.1);
      font-size: 16px;
      resize: vertical;
      min-height: 120px;
      line-height: 1.5;
      color: #1f2937;
    }

    textarea:focus {
      outline: none;
      border-color: var(--accent);
      background: #ffffff;
      box-shadow: 0 0 0 3px rgba(32, 112, 42, 0.25);
    }

    .feedback {
      font-size: 1rem;
      color: #1f2937;
      min-height: 1.4em;
      margin-top: 8px;
      text-align: center;
    }

    .button-link {
      background: none;
      border: none;
      color: #c0392b;
      cursor: pointer;
      font-family: inherit;
      font-size: 0.95rem;
      text-decoration: underline;
      margin-top: 8px;
    }

    .loading-inline {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      margin: 16px 0;
    }

    .loading-inline.hidden {
      display: none;
    }

    .loading-spinner {
      width: 18px;
      height: 18px;
      border: 3px solid rgba(32, 112, 42, 0.2);
      border-top-color: var(--yellow);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    #loading-final {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }

    #loading-final.hidden {
      display: none;
    }

    .loading-card {
      background: var(--panel);
      padding: 28px 36px;
      border-radius: 18px;
      text-align: center;
      box-shadow: 0 18px 54px rgba(0, 0, 0, 0.25);
    }

    .loading-card h4 {
      margin: 0;
      font-size: 1.2rem;
      color: #1f2937;
    }

    .loading-card p {
      color: #4b5563;
      margin-top: 8px;
    }

    @media (max-width: 980px) {
      .container {
        width: 92%;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>Protetor Selvagem</h1>
      <div class="subtitle">Agora vamos criar sua visão!</div>
    </div>

    <div class="content">
      <div style="margin-bottom: 20px">
        <a href="/pergunta_nome.html">
          <button class="btn-secondary">← Voltar</button>
        </a>
      </div>

      <h3>
        Olá <span id="nomeExibido" style="color:#c0392b"></span>! <br />
        Como você imagina a natureza caminhando ao lado do desenvolvimento?
      </h3>

      <audio id="audioPersonalizado" autoplay style="display:none">
        <source src="" type="audio/mpeg" />
      </audio>

      <form action="/resultado.html" method="GET">
        <input type="hidden" name="nome" id="nomeHidden" value="" />

        <textarea id="mundoPerfeito" name="mundo_perfeito" placeholder="Aguarde o reconhecimento de voz..." required
          readonly></textarea>

        <p class="feedback" id="voz-feedback"></p>

        <div id="loading-visao" class="loading-inline hidden">
          <div class="loading-spinner"></div>
          <p id="loading-visao-text">Carregando...</p>
        </div>

        <button type="button" id="retry-btn" class="button-link" hidden>
          [ Tentar novamente ]
        </button>
      </form>
    </div>
  </div>

  <div id="loading-final" class="hidden">
    <div class="loading-card">
      <div class="loading-spinner"></div>
      <h4>Gerando sua visão...</h4>
      <p>Estamos criando a imagem com base na sua descrição.</p>
    </div>
  </div>

  <script>
    (function () {
      const urlParams = new URLSearchParams(window.location.search);
      const nomeUsuario = urlParams.get("nome") || "Usuário";

      const nomeExibido = document.getElementById("nomeExibido");
      const nomeHidden = document.getElementById("nomeHidden");
      const audioEl = document.getElementById("audioPersonalizado");
      const descricaoEl = document.getElementById("mundoPerfeito");
      const feedbackEl = document.getElementById("voz-feedback");
      const loadingInline = document.getElementById("loading-visao");
      const loadingInlineText = document.getElementById("loading-visao-text");
      const retryBtn = document.getElementById("retry-btn");
      const loadingFinal = document.getElementById("loading-final");

      const SpeechRecognition =
        window.SpeechRecognition || window.webkitSpeechRecognition;

      let reconhecimentoAgendado = false;
      let requisicaoEmAndamento = false;
      let timeoutProcessamento = null;
      let recognizer;

      nomeExibido.textContent = nomeUsuario;
      nomeHidden.value = nomeUsuario;

      if (audioEl) {
        const sourceEl = audioEl.querySelector("source");
        sourceEl.src = `/audio_personalizado/${encodeURIComponent(nomeUsuario)}`;
        audioEl.load();
      }

      const mostrarInline = (msg) => {
        loadingInlineText.textContent = msg || "Carregando...";
        loadingInline.classList.remove("hidden");
      };

      const esconderInline = () => loadingInline.classList.add("hidden");
      const esconderRetry = () => (retryBtn.hidden = true);

      const mostrarRetry = (msg) => {
        if (msg) feedbackEl.textContent = msg;
        retryBtn.hidden = false;
        requisicaoEmAndamento = false;
        loadingFinal.classList.add("hidden");
      };

      const prepararParaNovaCaptura = () => {
        descricaoEl.value = "";
        descricaoEl.setAttribute("readonly", "readonly");
        feedbackEl.textContent = "";
        esconderInline();
        esconderRetry();
        loadingFinal.classList.add("hidden");
        requisicaoEmAndamento = false;

        if (timeoutProcessamento) {
          clearTimeout(timeoutProcessamento);
          timeoutProcessamento = null;
        }
      };

      if (!SpeechRecognition) {
        feedbackEl.textContent =
          "Seu navegador não suporta reconhecimento de voz. Digite sua visão manualmente.";
        descricaoEl.removeAttribute("readonly");
        return;
      }

      recognizer = new SpeechRecognition();
      recognizer.lang = "pt-BR";
      recognizer.interimResults = false;
      recognizer.maxAlternatives = 1;

      const iniciarReconhecimento = () => {
        if (reconhecimentoAgendado) return;

        reconhecimentoAgendado = true;
        esconderRetry();
        mostrarInline("Preparando microfone...");

        setTimeout(() => {
          try {
            recognizer.start();
          } catch (error) {
            reconhecimentoAgendado = false;

            if (error.name !== "InvalidStateError") {
              feedbackEl.textContent =
                "Não foi possível iniciar o microfone. Atualize a página e tente novamente.";
              esconderInline();
              mostrarRetry('Clique em "Tentar novamente" para tentar outra vez.');
            }
          }
        }, 300);
      };

      recognizer.addEventListener("start", () => {
        feedbackEl.textContent = "Estou ouvindo. Descreva sua visão com clareza.";
        mostrarInline("Estou ouvindo...");
      });

      recognizer.addEventListener("result", (event) => {
        const transcript = event.results[0][0]?.transcript?.trim() || "";

        if (!transcript) {
          recognizer.stop();
          feedbackEl.textContent = "Não entendi o que você disse. Tente novamente.";
          esconderInline();
          mostrarRetry('Clique em "Tentar novamente" e descreva novamente sua visão.');
          return;
        }

        descricaoEl.value = transcript;
        recognizer.stop();

        if (!requisicaoEmAndamento) {
          requisicaoEmAndamento = true;
          esconderInline();
          feedbackEl.textContent = "Visão capturada. Preparando geração...";

          if (timeoutProcessamento) clearTimeout(timeoutProcessamento);

          timeoutProcessamento = setTimeout(() => {
            loadingFinal.classList.remove("hidden");
            feedbackEl.textContent = "Gerando imagem, isso pode levar alguns segundos...";
            processarVisao(transcript);
          }, 800);
        }
      });

      recognizer.addEventListener("error", () => {
        feedbackEl.textContent =
          "Erro ao capturar áudio. Verifique o microfone e tente novamente.";
        esconderInline();

        mostrarRetry(
          'Clique em "Tentar novamente" após conceder acesso ao microfone.'
        );

        if (timeoutProcessamento) {
          clearTimeout(timeoutProcessamento);
          timeoutProcessamento = null;
        }
      });

      recognizer.addEventListener("end", () => {
        reconhecimentoAgendado = false;
        esconderInline();
      });

      const iniciarFluxo = () => {
        prepararParaNovaCaptura();

        if (!audioEl) {
          iniciarReconhecimento();
          return;
        }

        const tentarReproduzir = () => {
          audioEl.currentTime = 0;

          audioEl.play().catch(() => {
            feedbackEl.textContent = "Clique em qualquer lugar para ouvir as instruções.";

            document.addEventListener(
              "click",
              () => audioEl.play().catch(() => { }),
              { once: true }
            );
          });
        };

        tentarReproduzir();

        audioEl.addEventListener("ended", () => iniciarReconhecimento(), {
          once: true,
        });
      };

      retryBtn.addEventListener("click", () => {
        if (requisicaoEmAndamento) return;

        feedbackEl.textContent = "Reproduzindo instruções novamente...";

        if (timeoutProcessamento) {
          clearTimeout(timeoutProcessamento);
          timeoutProcessamento = null;
        }

        iniciarFluxo();
      });

      iniciarFluxo();

      async function processarVisao(descricao) {
        try {
          const resposta = await fetch("/gerar", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              nome: nomeUsuario,
              mundo_perfeito: descricao,
            }),
          });

          const data = await resposta.json();

          if (resposta.ok) {
            const params = new URLSearchParams({
              nome: data.nome,
              mundo_perfeito: data.mundo_perfeito,
              imagem_url: data.imagem_url,
            });

            window.location.href = `/resultado.html?${params.toString()}`;
            return;
          }

          throw new Error(data.erro || "Erro ao gerar a visão");
        } catch (erro) {
          console.error(erro);
          loadingFinal.classList.add("hidden");

          feedbackEl.textContent =
            "Não foi possível gerar a imagem. Tente novamente.";

          mostrarRetry(
            'Clique em "Tentar novamente" e descreva novamente sua visão.'
          );
        } finally {
          requisicaoEmAndamento = false;

          if (timeoutProcessamento) {
            clearTimeout(timeoutProcessamento);
            timeoutProcessamento = null;
          }
        }
      }
    })();
  </script>

</body>

</html>
