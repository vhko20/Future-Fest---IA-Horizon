<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mundo Perfeito - Como voc√™ imagina?</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, sans-serif;
        background: #055b03;
        min-height: 100vh;
        padding: 20px;
        line-height: 1.6;
        align-items: center;
        justify-content: center;
        display: flex;
      }

      .container {
        max-width: 900px;
        width: 100%;
        margin: 0 auto;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        border-radius: 24px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .header {
        background: #2a7e1e;
        color: white;
        padding: 40px 30px;
        text-align: center;
      }

      .header h1 {
        font-size: 3rem;
        font-weight: 800;
        margin-bottom: 10px;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .header .subtitle {
        font-size: 1.1rem;
        opacity: 0.9;
        font-weight: 300;
      }

      .content {
        padding: 40px 30px;
      }

      .form-group {
        margin-bottom: 30px;
      }

      .form-label {
        display: block;
        font-weight: 600;
        color: #374151;
        margin-bottom: 12px;
        font-size: 1rem;
      }

      textarea {
        width: 100%;
        padding: 16px 20px;
        border: 2px solid #e5e7eb;
        border-radius: 16px;
        font-size: 16px;
        font-family: inherit;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        background: #f9fafb;
        resize: vertical;
        min-height: 120px;
      }

      textarea:focus {
        outline: none;
        border-color: #f52b14;
        background: white;
        box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
        transform: translateY(-1px);
      }

      .hidden-audio {
        display: none;
      }

      .feedback {
        font-size: 1rem;
        color: #1f2937;
        min-height: 1.4em;
        margin-top: 8px;
        text-align: center;
      }

      .loading-inline {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        margin: 16px 0;
      }

      .loading-inline.hidden {
        display: none;
      }

      .loading-spinner {
        width: 18px;
        height: 18px;
        border: 3px solid rgba(5, 91, 3, 0.2);
        border-top-color: #e3e900;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .btn-secondary {
        background: #f3f4f6;
        color: #374151;
        border: 2px solid #e5e7eb;
        width: auto;
        padding: 8px 16px;
        font-size: 14px;
      }

      .btn-secondary:hover {
        background: #e5e7eb;
        transform: translateY(-1px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      .button-link {
        background: none;
        border: none;
        color: #f52b14;
        cursor: pointer;
        font-family: inherit;
        font-size: 0.95rem;
        text-decoration: underline;
        margin-top: 8px;
      }

      #loading-final {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.45);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 999;
      }

      #loading-final.hidden {
        display: none;
      }

      .loading-card {
        background: rgba(255, 255, 255, 0.95);
        padding: 28px 36px;
        border-radius: 18px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 14px;
        box-shadow: 0 18px 54px rgba(0, 0, 0, 0.18);
        max-width: 360px;
        text-align: center;
      }

      .loading-card h4 {
        margin: 0;
        font-size: 1.1rem;
        color: #1f2937;
      }

      .loading-card p {
        margin: 0;
        color: #4b5563;
        font-size: 0.95rem;
      }

      /* Responsividade */
      @media (max-width: 768px) {
        body {
          padding: 10px;
        }

        .container {
          border-radius: 16px;
        }

        .header {
          padding: 30px 20px;
        }

        .header h1 {
          font-size: 2rem;
        }

        .content {
          padding: 30px 20px;
        }
      }

      @media (max-width: 480px) {
        .header h1 {
          font-size: 1.8rem;
        }

        .header .subtitle {
          font-size: 1rem;
        }

        textarea,
        .btn {
          padding: 14px 16px;
          font-size: 15px;
        }
      }

      /* Anima√ß√µes */
      .fade-in {
        animation: fadeIn 0.6s ease-out;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üå≥ Protetor Selvagem</h1>
        <p class="subtitle">Agora vamos criar sua vis√£o!</p>
      </div>

      <div class="content">
        <div style="margin-bottom: 20px">
          <a href="/pergunta_nome.html">
            <button class="btn btn-secondary">‚Üê Voltar</button>
          </a>
        </div>

        <h3
          style="
            color: #374151;
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 25px;
            text-align: center;
          "
        >
          Ol√° <span id="nomeExibido" style="color: #f52b14"></span>! <br />Como
          voc√™ imagina a natureza caminhando ao lado do desenvolvimento!
        </h3>

        <!-- √Åudio personalizado oculto -->
        <div aria-hidden="true">
          <audio id="audioPersonalizado" autoplay class="hidden-audio">
            <source src="" type="audio/mpeg" />
            Seu navegador n√£o suporta o elemento de √°udio.
          </audio>
        </div>

        <!-- FORMUL√ÅRIO  -->
        <form action="/resultado.html" method="GET">
          <!-- Campo oculto para passar o nome -->
          <input type="hidden" name="nome" id="nomeHidden" value="" />

          <div class="form-group">
            <label for="mundoPerfeito" class="form-label"
              >Descreva sua vis√£o:</label
            >
            <textarea
              name="mundo_perfeito"
              id="mundoPerfeito"
              placeholder="Aguarde o reconhecimento de voz..."
              required
              readonly
            ></textarea>
          </div>
          <p class="feedback" id="voz-feedback"></p>
          <div id="loading-visao" class="loading-inline hidden">
            <div class="loading-spinner" role="status" aria-hidden="true"></div>
            <p id="loading-visao-text">Carregando...</p>
          </div>
          <button type="button" id="retry-btn" class="button-link" hidden>
            [ Tentar novamente ]
          </button>
        </form>
      </div>
    </div>

    <div id="loading-final" class="hidden" role="status" aria-live="polite">
      <div class="loading-card">
        <div class="loading-spinner" aria-hidden="true"></div>
        <h4>Gerando sua vis√£o...</h4>
        <p>Estamos criando a imagem com base na sua descri√ß√£o.</p>
      </div>
    </div>

    <script>
      (function () {
        const urlParams = new URLSearchParams(window.location.search);
        const nomeUsuario = urlParams.get("nome") || "Usu√°rio";

        const nomeExibido = document.getElementById("nomeExibido");
        const nomeHidden = document.getElementById("nomeHidden");
        const audioEl = document.getElementById("audioPersonalizado");
        const descricaoEl = document.getElementById("mundoPerfeito");
        const feedbackEl = document.getElementById("voz-feedback");
        const loadingInline = document.getElementById("loading-visao");
        const loadingInlineText = document.getElementById("loading-visao-text");
        const retryBtn = document.getElementById("retry-btn");
        const loadingFinal = document.getElementById("loading-final");
        const formulario = document.querySelector("form");
        const SpeechRecognition =
          window.SpeechRecognition || window.webkitSpeechRecognition;

        let reconhecimentoAgendado = false;
        let requisicaoEmAndamento = false;
        let timeoutProcessamento = null;
        let recognizer;

        nomeExibido.textContent = nomeUsuario;
        nomeHidden.value = nomeUsuario;

        if (audioEl) {
          const sourceEl = audioEl.querySelector("source");
          sourceEl.src = `/audio_personalizado/${encodeURIComponent(
            nomeUsuario
          )}`;
          audioEl.load();
        }

        const mostrarInline = (mensagem) => {
          loadingInlineText.textContent = mensagem || "Carregando...";
          loadingInline.classList.remove("hidden");
        };

        const esconderInline = () => {
          loadingInline.classList.add("hidden");
        };

        const mostrarRetry = (mensagem) => {
          if (mensagem) {
            feedbackEl.textContent = mensagem;
          }
          retryBtn.hidden = false;
          requisicaoEmAndamento = false;
          loadingFinal.classList.add("hidden");
        };

        const esconderRetry = () => {
          retryBtn.hidden = true;
        };

        const prepararParaNovaCaptura = () => {
          descricaoEl.value = "";
          descricaoEl.setAttribute("readonly", "readonly");
          feedbackEl.textContent = "";
          esconderInline();
          esconderRetry();
          loadingFinal.classList.add("hidden");
          requisicaoEmAndamento = false;
          if (timeoutProcessamento) {
            clearTimeout(timeoutProcessamento);
            timeoutProcessamento = null;
          }
          if (timeoutProcessamento) {
            clearTimeout(timeoutProcessamento);
            timeoutProcessamento = null;
          }
        };

        if (!SpeechRecognition) {
          feedbackEl.textContent =
            "Seu navegador n√£o suporta reconhecimento de voz. Digite sua vis√£o manualmente.";
          descricaoEl.removeAttribute("readonly");
          return;
        }

        recognizer = new SpeechRecognition();
        recognizer.lang = "pt-BR";
        recognizer.interimResults = false;
        recognizer.maxAlternatives = 1;

        const iniciarReconhecimento = () => {
          if (reconhecimentoAgendado) {
            return;
          }
          reconhecimentoAgendado = true;
          esconderRetry();
          mostrarInline("Preparando microfone...");
          window.setTimeout(() => {
            try {
              recognizer.start();
            } catch (error) {
              reconhecimentoAgendado = false;
              if (error.name !== "InvalidStateError") {
                feedbackEl.textContent =
                  "N√£o foi poss√≠vel iniciar o microfone. Atualize a p√°gina e tente novamente.";
                esconderInline();
                mostrarRetry(
                  'Clique em "Tentar novamente" para tentar outra vez.'
                );
              }
            }
          }, 300);
        };

        recognizer.addEventListener("start", () => {
          feedbackEl.textContent =
            "Estou ouvindo. Descreva sua vis√£o com clareza.";
          mostrarInline("Estou ouvindo...");
        });

        recognizer.addEventListener("result", (event) => {
          const transcript =
            event.results[0][0]?.transcript?.trim() || "";

          if (transcript) {
            descricaoEl.value = transcript;
            recognizer.stop();
            if (!requisicaoEmAndamento) {
              requisicaoEmAndamento = true;
              esconderInline();
              feedbackEl.textContent =
                "Vis√£o capturada. Preparando gera√ß√£o...";
              if (timeoutProcessamento) {
                clearTimeout(timeoutProcessamento);
              }
              timeoutProcessamento = window.setTimeout(() => {
                loadingFinal.classList.remove("hidden");
                feedbackEl.textContent =
                  "Gerando imagem, isso pode levar alguns segundos...";
                processarVisao(transcript);
              }, 800);
            }
          } else {
            recognizer.stop();
            feedbackEl.textContent =
              "N√£o entendi o que voc√™ disse. Tente novamente.";
            esconderInline();
            mostrarRetry(
              'Clique em "Tentar novamente" e descreva novamente sua vis√£o.'
            );
          }
        });

        recognizer.addEventListener("error", () => {
          feedbackEl.textContent =
            "Erro ao capturar √°udio. Verifique o microfone e tente novamente.";
          esconderInline();
          mostrarRetry(
            'Clique em "Tentar novamente" ap√≥s conceder acesso ao microfone.'
          );
          if (timeoutProcessamento) {
            clearTimeout(timeoutProcessamento);
            timeoutProcessamento = null;
          }
        });

        recognizer.addEventListener("end", () => {
          reconhecimentoAgendado = false;
          esconderInline();
        });

        const iniciarFluxo = () => {
          prepararParaNovaCaptura();
          if (!audioEl) {
            iniciarReconhecimento();
            return;
          }
          const tentarReproduzir = () => {
            audioEl.currentTime = 0;
            audioEl.play().catch(() => {
              feedbackEl.textContent =
                "Clique em qualquer lugar para ouvir as instru√ß√µes.";
              document.addEventListener(
                "click",
                () => {
                  audioEl.play().catch(() => {});
                },
                { once: true }
              );
            });
          };
          tentarReproduzir();
          audioEl.addEventListener(
            "ended",
            () => {
              iniciarReconhecimento();
            },
            { once: true }
          );
        };

        retryBtn.addEventListener("click", () => {
          if (requisicaoEmAndamento) {
            return;
          }
          feedbackEl.textContent = "Reproduzindo instru√ß√µes novamente...";
          if (timeoutProcessamento) {
            clearTimeout(timeoutProcessamento);
            timeoutProcessamento = null;
          }
          iniciarFluxo();
        });

        iniciarFluxo();

        async function processarVisao(descricao) {
          try {
            const resposta = await fetch("/gerar", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                nome: nomeUsuario,
                mundo_perfeito: descricao,
              }),
            });

            const data = await resposta.json();

            if (resposta.ok) {
              const params = new URLSearchParams({
                nome: data.nome,
                mundo_perfeito: data.mundo_perfeito,
                imagem_url: data.imagem_url,
              });
              window.location.href = `/resultado.html?${params.toString()}`;
              return;
            }

            throw new Error(data.erro || "Erro ao gerar a vis√£o");
          } catch (erro) {
            console.error(erro);
            loadingFinal.classList.add("hidden");
            feedbackEl.textContent =
              "N√£o foi poss√≠vel gerar a imagem. Tente novamente.";
            mostrarRetry(
              'Clique em "Tentar novamente" e descreva novamente sua vis√£o.'
            );
          } finally {
            requisicaoEmAndamento = false;
            if (timeoutProcessamento) {
              clearTimeout(timeoutProcessamento);
              timeoutProcessamento = null;
            }
          }
        }
      })();
    </script>
  </body>
</html>
